<pages:BasePage x:Class="Heimatplatz.Features.Properties.Presentation.EditPropertyPage"
      x:Name="RootPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Heimatplatz.Features.Properties.Presentation"
      xmlns:models="using:Heimatplatz.Features.Properties.Contracts.Models"
      xmlns:controls="using:Heimatplatz.Features.Properties.Controls"
      xmlns:pages="using:UnoFramework.Pages"
      NavigationCacheMode="Disabled"
      Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <pages:BasePage.Resources>
        <!-- Consistent corner radius for all input controls -->
        <Style TargetType="TextBox" BasedOn="{StaticResource DefaultTextBoxStyle}">
            <Setter Property="CornerRadius" Value="{StaticResource RadiusSm}" />
        </Style>
        <Style TargetType="ComboBox" BasedOn="{StaticResource DefaultComboBoxStyle}">
            <Setter Property="CornerRadius" Value="{StaticResource RadiusSm}" />
        </Style>
    </pages:BasePage.Resources>

    <!-- Visual States for Responsive Layout -->
    <VisualStateManager.VisualStateGroups>
        <VisualStateGroup x:Name="WindowSizeStates">
            <VisualState x:Name="WideState">
                <VisualState.StateTriggers>
                    <AdaptiveTrigger MinWindowWidth="600" />
                </VisualState.StateTriggers>
            </VisualState>

            <VisualState x:Name="NarrowState">
                <VisualState.StateTriggers>
                    <AdaptiveTrigger MinWindowWidth="0" />
                </VisualState.StateTriggers>
                <VisualState.Setters>
                    <!-- Address Layout - Stack vertically -->
                    <Setter Target="AddressLayout.RowSpacing" Value="8" />
                    <Setter Target="AddressField.(Grid.Row)" Value="0" />
                    <Setter Target="AddressField.(Grid.Column)" Value="0" />
                    <Setter Target="AddressField.(Grid.ColumnSpan)" Value="2" />
                    <Setter Target="OrtPickerField.(Grid.Row)" Value="1" />
                    <Setter Target="OrtPickerField.(Grid.Column)" Value="0" />
                    <Setter Target="OrtPickerField.(Grid.ColumnSpan)" Value="2" />

                    <!-- House Details Layout - Stack vertically -->
                    <Setter Target="HouseDetailsLayout.RowSpacing" Value="8" />
                    <Setter Target="WohnflaecheField.(Grid.Row)" Value="0" />
                    <Setter Target="WohnflaecheField.(Grid.Column)" Value="0" />
                    <Setter Target="WohnflaecheField.(Grid.ColumnSpan)" Value="2" />
                    <Setter Target="GrundstuecksflaecheField.(Grid.Row)" Value="1" />
                    <Setter Target="GrundstuecksflaecheField.(Grid.Column)" Value="0" />
                    <Setter Target="GrundstuecksflaecheField.(Grid.ColumnSpan)" Value="2" />
                    <Setter Target="ZimmerField.(Grid.Row)" Value="2" />
                    <Setter Target="ZimmerField.(Grid.Column)" Value="0" />
                    <Setter Target="ZimmerField.(Grid.ColumnSpan)" Value="2" />
                    <Setter Target="BaujahrField.(Grid.Row)" Value="3" />
                    <Setter Target="BaujahrField.(Grid.Column)" Value="0" />
                    <Setter Target="BaujahrField.(Grid.ColumnSpan)" Value="2" />
                </VisualState.Setters>
            </VisualState>
        </VisualStateGroup>
    </VisualStateManager.VisualStateGroups>

    <ScrollViewer>
        <StackPanel Padding="12" Spacing="8" MaxWidth="900">

            <!-- Loading Indicator -->
            <ProgressRing IsActive="{Binding IsLoading, Mode=OneWay}"
                          Width="40"
                          Height="40"
                          Margin="0,20,0,20"
                          Visibility="{Binding IsLoading, Mode=OneWay}" />

            <!-- Success/Error Messages -->
            <InfoBar Visibility="{Binding ShowSuccess, Mode=OneWay}"
                     Severity="Success"
                     Title="Erfolgreich"
                     Message="Immobilie wurde aktualisiert."
                     IsClosable="True"
                     IsOpen="True" />

            <InfoBar Visibility="{Binding HasError, Mode=OneWay}"
                     Severity="Error"
                     Title="Fehler"
                     Message="{Binding ErrorMessage, Mode=OneWay}"
                     IsClosable="True"
                     IsOpen="True" />

            <ComboBox Header="Immobilientyp *"
                      ItemsSource="{Binding PropertyTypes}"
                      SelectedItem="{Binding SelectedPropertyTypeItem, Mode=TwoWay}"
                      DisplayMemberPath="DisplayName" />

            <TextBox Header="Titel *"
                     Text="{Binding Titel, Mode=TwoWay}"
                     PlaceholderText="z.B. Schöne 3-Zimmer Wohnung" />

            <TextBox Header="Beschreibung *"
                     Text="{Binding Beschreibung, Mode=TwoWay}"
                     PlaceholderText="Detaillierte Beschreibung (mind. 50 Zeichen)"
                     TextWrapping="Wrap"
                     AcceptsReturn="True"
                     MinHeight="80"
                     MaxHeight="200" />

            <Grid x:Name="AddressLayout" ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <StackPanel x:Name="OrtPickerField"
                            Grid.Row="0"
                            Grid.Column="0"
                            Spacing="4">
                    <TextBlock Text="Ort *"
                               Style="{StaticResource CaptionTextBlockStyle}" />
                    <controls:OrtPicker Bezirke="{Binding Bezirke}"
                                        IsSingleSelect="True"
                                        SelectedGemeindeId="{Binding SelectedGemeindeId, Mode=TwoWay}"
                                        HorizontalAlignment="Stretch" />
                </StackPanel>

                <TextBox x:Name="AddressField"
                         Grid.Row="0"
                         Grid.Column="1"
                         Header="Straße *"
                         Text="{Binding Adresse, Mode=TwoWay}"
                         PlaceholderText="Straße und Hausnummer"
                         HorizontalAlignment="Stretch" />
            </Grid>

            <!-- Preis -->
            <TextBox Header="Preis (€) *"
                     Text="{Binding Preis, Mode=TwoWay}"
                     PlaceholderText="z.B. 350000"
                     InputScope="Number" />

            <!-- Immobilien-Details (Haus) -->
            <Grid x:Name="HouseDetailsLayout"
                  ColumnSpacing="8"
                  Visibility="{Binding IsHouseType, Mode=OneWay}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBox x:Name="WohnflaecheField"
                         Grid.Row="0"
                         Grid.Column="0"
                         Header="Wohnfläche (m²)"
                         Text="{Binding WohnflaecheM2, Mode=TwoWay}"
                         PlaceholderText="90"
                         InputScope="Number"
                         HorizontalAlignment="Stretch" />

                <TextBox x:Name="GrundstuecksflaecheField"
                         Grid.Row="0"
                         Grid.Column="1"
                         Header="Grundstücksfläche (m²)"
                         Text="{Binding GrundstuecksflaecheM2, Mode=TwoWay}"
                         PlaceholderText="500"
                         InputScope="Number"
                         HorizontalAlignment="Stretch" />

                <TextBox x:Name="ZimmerField"
                         Grid.Row="1"
                         Grid.Column="0"
                         Header="Zimmer"
                         Text="{Binding Zimmer, Mode=TwoWay}"
                         PlaceholderText="3"
                         InputScope="Number"
                         HorizontalAlignment="Stretch" />

                <TextBox x:Name="BaujahrField"
                         Grid.Row="1"
                         Grid.Column="1"
                         Header="Baujahr"
                         Text="{Binding Baujahr, Mode=TwoWay}"
                         PlaceholderText="2005"
                         InputScope="Number"
                         HorizontalAlignment="Stretch" />
            </Grid>

            <!-- Grundstück (Land) -->
            <StackPanel Spacing="8"
                        Visibility="{Binding IsLandType, Mode=OneWay}">
                <TextBox Header="Grundstücksfläche (m²)"
                         Text="{Binding GrundstuecksflaecheM2, Mode=TwoWay}"
                         PlaceholderText="500"
                         InputScope="Number"
                         MinWidth="150" />
            </StackPanel>

            <!-- Fotos -->
            <StackPanel Spacing="8" Margin="0,8,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0"
                               Style="{StaticResource BodyStrongTextBlockStyle}"
                               VerticalAlignment="Center">
                        <Run Text="Fotos" />
                        <Run Text="{Binding ImageCount, Mode=OneWay}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                        <Run Text="/ 20" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    </TextBlock>
                    <Button Grid.Column="1"
                            Command="{Binding AddPhotosCommand}"
                            Style="{StaticResource TextButtonStyle}"
                            CornerRadius="{StaticResource RadiusSm}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="&#xE710;" FontSize="14" />
                            <TextBlock Text="Fotos hinzufügen" />
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- Image List -->
                <ItemsRepeater ItemsSource="{Binding Images}">
                    <ItemsRepeater.Layout>
                        <UniformGridLayout MinItemWidth="140"
                                           MinItemHeight="120"
                                           MinColumnSpacing="8"
                                           MinRowSpacing="8"
                                           ItemsStretch="Fill" />
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate>
                            <Border CornerRadius="{StaticResource RadiusSm}"
                                    BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                                <Grid>
                                    <Image Source="{Binding DisplaySource}"
                                           Stretch="UniformToFill"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center" />
                                    <Button HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Padding="4"
                                            Margin="4"
                                            MinWidth="0"
                                            MinHeight="0"
                                            Command="{Binding DataContext.RemoveImageCommand, ElementName=RootPage}"
                                            CommandParameter="{Binding}"
                                            Background="Transparent"
                                            BorderThickness="0">
                                        <FontIcon Glyph="&#xE711;" FontSize="12"
                                                  Foreground="{ThemeResource SystemFillColorCriticalBrush}" />
                                    </Button>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>

                <!-- Empty State -->
                <Border Visibility="{Binding HasNoImages, Mode=OneWay}"
                        CornerRadius="{StaticResource RadiusSm}"
                        BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        Padding="24"
                        HorizontalAlignment="Stretch">
                    <StackPanel HorizontalAlignment="Center" Spacing="8">
                        <FontIcon Glyph="&#xE722;"
                                  FontSize="32"
                                  HorizontalAlignment="Center"
                                  Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                        <TextBlock Text="Noch keine Fotos hinzugefügt"
                                   HorizontalAlignment="Center"
                                   Style="{StaticResource CaptionTextBlockStyle}"
                                   Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- Action Button -->
            <Button Margin="0,16,0,8"
                    Content="Änderungen speichern"
                    Command="{Binding UpdatePropertyCommand}"
                    HorizontalAlignment="Stretch"
                    Height="48"
                    Style="{StaticResource AccentButtonStyle}"
                    CornerRadius="{StaticResource RadiusSm}" />

            <TextBlock Text="* Pflichtfelder"
                       FontSize="11"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       Margin="0,4,0,0" />

        </StackPanel>
    </ScrollViewer>
</pages:BasePage>
