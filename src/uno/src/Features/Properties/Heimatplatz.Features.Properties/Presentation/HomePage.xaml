<ufp:BasePage x:Class="Heimatplatz.Features.Properties.Presentation.HomePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:Heimatplatz.Features.Properties.Presentation"
      xmlns:controls="using:Heimatplatz.Features.Properties.Controls"
      xmlns:utu="using:Uno.Toolkit.UI"
      xmlns:uen="using:Uno.Extensions.Navigation.UI"
      xmlns:uc="using:UnoFramework.Controls"
      xmlns:ufp="using:UnoFramework.Pages"
      NavigationCacheMode="Disabled">

    <!--
    HomePage - Premium Editorial Design
    Elegantes Layout mit grosszuegigem Weissraum
    Header wurde in Shell verschoben (AppHeader Control)
    -->

    <Grid x:Name="RootGrid"
          Background="{ThemeResource BackgroundBrush}"
          AutomationProperties.AutomationId="HomePage_Root">

        <uc:BusyOverlay IsBusy="{Binding IsBusy}"
                        BusyMessage="{Binding BusyMessage}"
                        AutomationProperties.AutomationId="HomePage_BusyOverlay">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Desktop Filter ist jetzt im AppHeader (HeaderCenter Region) -->

                <!-- Mobile Filter (unter 905px) — einklappbar -->
                <Border Grid.Row="0"
                        Background="{ThemeResource SurfaceBrush}"
                        BorderBrush="{ThemeResource BorderBrush}"
                        BorderThickness="0,0,0,1"
                        Visibility="{utu:Responsive Narrowest=Visible, Narrow=Visible, Normal=Visible, Wide=Collapsed}"
                        AutomationProperties.AutomationId="HomePage_MobileFilter">
                    <StackPanel>
                        <!-- Filter Header: Immer sichtbar — ganzer Bereich klickbar -->
                        <Button Command="{Binding ToggleFilterExpandedCommand}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch"
                                Background="Transparent"
                                BorderThickness="0"
                                Padding="12,8"
                                MinHeight="44"
                                AutomationProperties.AutomationId="HomePage_MobileFilterToggle">
                            <Grid AutomationProperties.AutomationId="HomePage_MobileFilterHeader">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Filter-Icon + Label -->
                                <StackPanel Grid.Column="0"
                                            Orientation="Horizontal"
                                            Spacing="6"
                                            VerticalAlignment="Center">
                                    <FontIcon Glyph="&#xE71C;"
                                              FontSize="14"
                                              Foreground="{ThemeResource OnSurfaceVariantBrush}" />
                                    <TextBlock Text="Filter"
                                               FontSize="13"
                                               FontWeight="SemiBold"
                                               Foreground="{ThemeResource OnSurfaceBrush}"
                                               VerticalAlignment="Center" />
                                </StackPanel>

                                <!-- Ergebnis-Counter -->
                                <TextBlock Grid.Column="1"
                                           Text="{Binding ResultCountText}"
                                           FontWeight="SemiBold"
                                           Foreground="{ThemeResource OnSurfaceVariantBrush}"
                                           FontSize="12"
                                           HorizontalAlignment="Right"
                                           VerticalAlignment="Center"
                                           Margin="0,0,8,0"
                                           AutomationProperties.AutomationId="HomePage_MobileResultCount" />

                                <!-- Chevron-Icon: Auf/Zuklappen -->
                                <FontIcon Grid.Column="2"
                                          Glyph="{Binding FilterToggleGlyph}"
                                          FontSize="12"
                                          Foreground="{ThemeResource OnSurfaceVariantBrush}"
                                          VerticalAlignment="Center" />
                            </Grid>
                        </Button>

                        <!-- Filter Body: Einklappbar -->
                        <StackPanel Spacing="8"
                                    Padding="12,0,12,8"
                                    Visibility="{Binding IsFilterExpanded}"
                                    AutomationProperties.AutomationId="HomePage_MobileFilterBody">

                            <!-- OrtPicker und Alters-Filter -->
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <controls:OrtPicker Bezirke="{Binding Bezirke}"
                                                    SelectedOrte="{Binding SelectedOrte, Mode=TwoWay}"
                                                    HorizontalAlignment="Stretch"
                                                    AutomationProperties.AutomationId="HomePage_MobileOrtPicker" />
                                <controls:AgeFilterPicker SelectedAgeFilter="{Binding SelectedAgeFilter, Mode=TwoWay}"
                                                          HorizontalAlignment="Stretch"
                                                          AutomationProperties.AutomationId="HomePage_MobileAgeFilterPicker" />
                            </StackPanel>

                            <!-- Filter Chips: Immobilientyp -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <controls:FilterChip Label="Haus"
                                                     IsSelected="{Binding IsHausSelected, Mode=TwoWay}" />
                                <controls:FilterChip Label="Grund"
                                                     IsSelected="{Binding IsGrundstueckSelected, Mode=TwoWay}" />
                                <controls:FilterChip Label="ZV"
                                                     IsSelected="{Binding IsZwangsversteigerungSelected, Mode=TwoWay}" />
                            </StackPanel>

                            <!-- Filter Chips: Anbietertyp -->
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <controls:FilterChip Label="Privat"
                                                     IsSelected="{Binding IsPrivateSelected, Mode=TwoWay}" />
                                <controls:FilterChip Label="Makler"
                                                     IsSelected="{Binding IsBrokerSelected, Mode=TwoWay}" />
                                <controls:FilterChip Label="Portal"
                                                     IsSelected="{Binding IsPortalSelected, Mode=TwoWay}" />
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Content: Responsives Grid Layout -->
                <ScrollViewer Grid.Row="1"
                              Padding="{utu:Responsive Narrowest='12', Normal='20,16'}"
                              AutomationProperties.AutomationId="HomePage_ScrollViewer">
                    <StackPanel>
                        <ItemsRepeater ItemsSource="{Binding Properties}"
                                       utu:ItemsRepeaterExtensions.SupportsIncrementalLoading="True"
                                       AutomationProperties.AutomationId="HomePage_PropertyList">
                            <ItemsRepeater.Layout>
                                <UniformGridLayout Orientation="Horizontal"
                                                   MinItemWidth="240"
                                                   MinItemHeight="330"
                                                   MinRowSpacing="16"
                                                   MinColumnSpacing="16"
                                                   ItemsStretch="Fill" />
                            </ItemsRepeater.Layout>
                            <ItemsRepeater.ItemTemplate>
                                <DataTemplate>
                                    <!-- DO NOT add Loaded="OnPropertyCardLoaded" here.
                                         Setting DependencyProperties (IsFavorite/IsBlocked) during
                                         ItemsRepeater rendering triggers a synchronous recursive cascade
                                         through Uno's DependencyObjectStore → BindingExpression →
                                         OnValueChanged → StackOverflow.
                                         Status is loaded on-demand in PropertyCard.OnMenuFlyoutOpening. -->
                                    <controls:PropertyCard Property="{Binding}"
                                                           IsAuthenticated="{Binding DataContext.IsAuthenticated, ElementName=RootGrid}"
                                                           CardClicked="OnPropertyCardClicked"
                                                           PropertyBlocked="OnPropertyBlocked"
                                                           PropertyFavorited="OnPropertyFavorited"
                                                           AutomationProperties.AutomationId="HomePage_PropertyCard" />
                                </DataTemplate>
                            </ItemsRepeater.ItemTemplate>
                        </ItemsRepeater>

                        <!-- Loading Indicator for Pagination -->
                        <ProgressRing IsActive="{Binding Properties.IsLoading}"
                                      Visibility="{Binding Properties.HasMoreItems}"
                                      Width="32"
                                      Height="32"
                                      Margin="0,16,0,0"
                                      HorizontalAlignment="Center"
                                      AutomationProperties.AutomationId="HomePage_LoadingIndicator" />

                        <!-- Footer -->
                        <Border Margin="0,32,0,16"
                                Padding="0,16,0,0"
                                BorderBrush="{ThemeResource BorderBrush}"
                                BorderThickness="0,1,0,0"
                                AutomationProperties.AutomationId="HomePage_Footer">
                            <StackPanel Orientation="Horizontal"
                                        HorizontalAlignment="Center"
                                        Spacing="24">
                                <HyperlinkButton Content="Datenschutz"
                                                 uen:Navigation.Request="PrivacyPolicy"
                                                 Foreground="{ThemeResource OnSurfaceVariantBrush}"
                                                 FontSize="12"
                                                 AutomationProperties.AutomationId="HomePage_PrivacyPolicyLink" />
                                <TextBlock Text="Heimatplatz"
                                           Foreground="{ThemeResource OnSurfaceVariantBrush}"
                                           FontSize="12"
                                           Opacity="0.6"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <!-- Empty State: Schlicht -->
                <StackPanel Grid.Row="1"
                            Visibility="{Binding IsEmpty}"
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Spacing="8"
                            AutomationProperties.AutomationId="HomePage_EmptyState">
                    <TextBlock Text="—"
                               FontSize="32"
                               Foreground="{ThemeResource OnSurfaceVariantBrush}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Keine Treffer"
                               FontSize="14"
                               Foreground="{ThemeResource OnSurfaceVariantBrush}"
                               HorizontalAlignment="Center"
                               AutomationProperties.AutomationId="HomePage_EmptyText" />
                </StackPanel>
            </Grid>
        </uc:BusyOverlay>
    </Grid>
</ufp:BasePage>
