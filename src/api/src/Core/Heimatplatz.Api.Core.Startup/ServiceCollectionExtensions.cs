using Heimatplatz.Api.Core.Data;
using Heimatplatz.Api.Core.Data.Configuration;
using Heimatplatz.Api.Core.Data.Seeding;
using Heimatplatz.Api.Core.Data.Seeding.Configuration;
using Heimatplatz.Api.Features.Auth.Configuration;
using Heimatplatz.Api.Features.Legal.Configuration;
using Heimatplatz.Api.Features.Locations.Configuration;
using Heimatplatz.Api.Features.Properties.Configuration;
using Heimatplatz.Api.Features.ForeclosureAuctions.Configuration;
using Heimatplatz.Api.Features.Notifications.Configuration;
using Heimatplatz.Api.Features.PropertyImport.Configuration;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;

// Feature endpoint namespaces
using Heimatplatz.Api.Features.Auth;
using Heimatplatz.Api.Features.Legal;
using Heimatplatz.Api.Features.Locations;
using Heimatplatz.Api.Features.Properties;
using Heimatplatz.Api.Features.ForeclosureAuctions;
using Heimatplatz.Api.Features.Notifications;
using Heimatplatz.Api.Features.Properties.Endpoints;
using Heimatplatz.Api.Features.PropertyImport;

namespace Heimatplatz.Api.Core.Startup;

public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddApiServices(this IServiceCollection services, IConfiguration configuration)
    {
        // Data (must be before features to register DbContext first)
        services.AddAppData(configuration);
        services.AddDataSeeding();

        // HttpContext für Handler, die den authentifizierten User benötigen
        services.AddHttpContextAccessor();

        services.AddShinyServiceRegistry();
        services.AddShinyMediator();

        // Features
        services.AddAuthFeature();
        services.AddLegalFeature();
        services.AddLocationsFeature();
        services.AddPropertiesFeature();
        services.AddForeclosureAuctionsFeature();
        services.AddNotificationsFeature(configuration);
        services.AddPropertyImportFeature();

        return services;
    }

    public static WebApplication MapEndpoints(this WebApplication app)
    {
        // Feature endpoints (generated by Shiny.Mediator.AspNet)
        // Call each feature's generated endpoints explicitly to avoid ambiguity
        Heimatplatz.Api.Features.Auth.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);
        Heimatplatz.Api.Features.Legal.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);
        Heimatplatz.Api.Features.Locations.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);
        Heimatplatz.Api.Features.Properties.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);
        Heimatplatz.Api.Features.ForeclosureAuctions.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);
        Heimatplatz.Api.Features.Notifications.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);
        Heimatplatz.Api.Features.PropertyImport.MediatorEndpoints.MapGeneratedMediatorEndpoints(app);

        // Manuell registrierte Endpoints (multipart/form-data Uploads)
        app.MapPropertyImageEndpoints();

        return app;
    }

    /// <summary>
    /// Initialisiert die Datenbank und führt optional Seeding aus.
    /// Basiert auf den DatabaseOptions aus appsettings.{Environment}.json.
    /// </summary>
    public static async Task InitializeDatabaseAsync(this WebApplication app)
    {
        var options = app.Services.GetRequiredService<IOptions<DatabaseOptions>>().Value;
        var configuration = app.Services.GetRequiredService<IConfiguration>();
        var logger = app.Services.GetRequiredService<ILoggerFactory>().CreateLogger("DatabaseInitialization");

        // Skip database initialization wenn weder Migration noch Seeding aktiviert sind
        // (z.B. für Build-Tools wie OpenAPI Generator die ohne echte DB laufen)
        if (!options.AutoMigrate && !options.EnableSeeding)
        {
            logger.LogDebug("Database initialization skipped (AutoMigrate=false, EnableSeeding=false).");
            return;
        }

        // Validierung: Connection String muss zur Laufzeit konfiguriert sein
        // :memory: ist nur für Build-Tools erlaubt, nicht für echte Anwendungen
        var connectionString = configuration.GetConnectionString("DefaultConnection");
        if (string.IsNullOrWhiteSpace(connectionString) || connectionString == "Data Source=:memory:")
        {
            logger.LogCritical(
                "Connection string 'DefaultConnection' is not configured or uses in-memory placeholder. " +
                "Please set it in appsettings.{{Environment}}.json or via environment variable " +
                "'ConnectionStrings__DefaultConnection'.");
            throw new InvalidOperationException(
                "Connection string 'DefaultConnection' is not configured. " +
                "Please set it in appsettings.{Environment}.json or via environment variable " +
                "'ConnectionStrings__DefaultConnection'.");
        }

        logger.LogInformation("Database initialization started. AutoMigrate={AutoMigrate}, EnableSeeding={EnableSeeding}",
            options.AutoMigrate, options.EnableSeeding);

        // Auto-Migration wenn aktiviert (Development)
        if (options.AutoMigrate)
        {
            logger.LogInformation("Running database migrations...");
            await using var scope = app.Services.CreateAsyncScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            // Prüfen ob die Datenbank existiert - wenn nicht, nutze EnsureCreated
            // Dies ist nötig da EnsureCreated kein Migration-Tracking macht
            if (!await dbContext.Database.CanConnectAsync())
            {
                logger.LogInformation("Database does not exist, creating with EnsureCreated...");
                await dbContext.Database.EnsureCreatedAsync();
            }
            else
            {
                // Bei existierender DB versuche Migrations anzuwenden
                try
                {
                    await dbContext.Database.MigrateAsync();
                }
                catch (Exception ex) when (ex.Message.Contains("PendingModelChanges"))
                {
                    logger.LogWarning("Pending model changes detected. For Development, recreating database...");
                    await dbContext.Database.EnsureDeletedAsync();
                    await dbContext.Database.EnsureCreatedAsync();
                }
            }
            logger.LogInformation("Database migrations completed.");
        }

        // Seeding wenn aktiviert (Development)
        if (options.EnableSeeding)
        {
            logger.LogInformation("Running database seeders...");
            using var scope = app.Services.CreateScope();
            var seederRunner = scope.ServiceProvider.GetRequiredService<SeederRunner>();
            await seederRunner.RunAllSeedersAsync();
            logger.LogInformation("Database seeding completed.");
        }
    }
}