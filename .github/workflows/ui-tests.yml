name: UI Tests

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'src/uno/**'
      - '.github/workflows/ui-tests.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'src/uno/**'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Test Platform'
        required: true
        default: 'Browser'
        type: choice
        options:
          - Browser
          - Android
          - iOS
          - All

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # WebAssembly/Browser Tests
  browser-tests:
    name: Browser Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'Browser' || github.event.inputs.platform == 'All' || github.event.inputs.platform == ''

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore src/uno/uno.slnx

      - name: Build WebAssembly App
        run: |
          dotnet build src/uno/src/Heimatplatz.App/Heimatplatz.App.csproj \
            -c Release \
            -f net8.0-browserwasm

      - name: Start WebAssembly App
        run: |
          cd src/uno/src/Heimatplatz.App
          dotnet run -c Release -f net8.0-browserwasm &
          sleep 30  # Warten bis App gestartet

      - name: Run UI Tests (Browser)
        env:
          UITEST_PLATFORM: Browser
          UITEST_WASM_URI: http://localhost:5000
        run: |
          dotnet test src/uno/tests/UITests/Heimatplatz.Core.UITests \
            --filter "Category=Smoke|Category=Core" \
            --logger "trx;LogFileName=browser-test-results.trx" \
            --results-directory ./TestResults

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: browser-test-results
          path: ./TestResults

  # Android Tests (nur auf Ubuntu Self-Hosted Runner mit Android Emulator)
  android-tests:
    name: Android Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'Android' || github.event.inputs.platform == 'All'
    continue-on-error: true  # Android Emulator auf GitHub Actions ist instabil

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Uno Workloads
        run: dotnet workload install android

      - name: Restore dependencies
        run: dotnet restore src/uno/uno.slnx

      - name: Build Android App
        run: |
          dotnet build src/uno/src/Heimatplatz.App/Heimatplatz.App.csproj \
            -c Release \
            -f net8.0-android

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel_5
          script: |
            adb install -r src/uno/src/Heimatplatz.App/bin/Release/net8.0-android/*.apk
            dotnet test src/uno/tests/UITests/Heimatplatz.Core.UITests \
              --filter "Category=Smoke|Category=Android" \
              --logger "trx;LogFileName=android-test-results.trx" \
              --results-directory ./TestResults
        env:
          UITEST_PLATFORM: Android
          UITEST_ANDROID_PACKAGE: com.companyname.heimatplatz

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-test-results
          path: ./TestResults

  # iOS Tests (nur auf macOS)
  ios-tests:
    name: iOS Tests
    runs-on: macos-14
    if: github.event.inputs.platform == 'iOS' || github.event.inputs.platform == 'All'
    continue-on-error: true  # iOS Simulator kann instabil sein

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Uno Workloads
        run: dotnet workload install ios maccatalyst

      - name: Restore dependencies
        run: dotnet restore src/uno/uno.slnx

      - name: Build iOS App
        run: |
          dotnet build src/uno/src/Heimatplatz.App/Heimatplatz.App.csproj \
            -c Release \
            -f net8.0-ios

      - name: Boot iOS Simulator
        run: |
          xcrun simctl list devices
          DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | grep -oE '[A-F0-9-]{36}')
          xcrun simctl boot "$DEVICE_ID" || true

      - name: Install App on Simulator
        run: |
          APP_PATH=$(find src/uno/src/Heimatplatz.App/bin/Release/net8.0-ios -name "*.app" | head -1)
          xcrun simctl install booted "$APP_PATH"

      - name: Run UI Tests (iOS)
        env:
          UITEST_PLATFORM: iOS
          UITEST_IOS_BUNDLE: com.companyname.heimatplatz
        run: |
          dotnet test src/uno/tests/UITests/Heimatplatz.Core.UITests \
            --filter "Category=Smoke|Category=iOS" \
            --logger "trx;LogFileName=ios-test-results.trx" \
            --results-directory ./TestResults

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-test-results
          path: ./TestResults

  # Zusammenfassung
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [browser-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./TestResults
          merge-multiple: true

      - name: Test Summary
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: UI Test Results
          path: './TestResults/**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false
